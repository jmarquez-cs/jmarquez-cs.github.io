var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);import{f as i,k as s,e as n}from"./message.Ve-2rN-7.js";function r(){const t={};return t.promise=new Promise((e,i)=>{t.resolve=e,t.reject=i}),t}class h{constructor(t){if(e(this,"buffer"),e(this,"mask"),e(this,"top"),e(this,"btm"),e(this,"next"),!(t>0)||t-1&t)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){const t=this.buffer[this.btm];if(void 0!==t)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return void 0===this.buffer[this.btm]}}class o{constructor(t={}){e(this,"size"),e(this,"hwm"),e(this,"head"),e(this,"tail"),this.hwm=t.splitLimit??16,this.head=new h(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return null!=(null==t?void 0:t.byteLength)?t.byteLength:1}push(t){if(null!=(null==t?void 0:t.value)&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){const e=this.head;this.head=e.next=new h(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null==t?void 0:t.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}let l=class extends Error{constructor(t,i){super(t??"The operation was aborted"),e(this,"type"),e(this,"code"),this.type="aborted",this.code=i??"ABORT_ERR"}};function a(t={}){return function(t,e){e=e??{};let i,s,n,h=e.onEnd,a=new o,u=r();const c=async()=>{try{return a.isEmpty()?n?{done:!0}:await new Promise((e,n)=>{s=r=>{s=null,a.push(r);try{e(t(a))}catch(h){n(h)}return i}}):t(a)}finally{a.isEmpty()&&queueMicrotask(()=>{u.resolve(),u=r()})}},f=t=>null!=s?s(t):(a.push(t),i),d=t=>(a=new o,null!=s?s({error:t}):(a.push({error:t}),i)),p=t=>{if(n)return i;if(!0!==(null==e?void 0:e.objectMode)&&null==(null==t?void 0:t.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return f({done:!1,value:t})},b=t=>n?i:(n=!0,null!=t?d(t):f({done:!0})),w=()=>(a=new o,b(),{done:!0}),v=t=>(b(t),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:w,throw:v,push:p,end:b,get readableLength(){return a.size},onEmpty:async t=>{const e=null==t?void 0:t.signal;if(null==e||e.throwIfAborted(),a.isEmpty())return;let i,s;null!=e&&(i=new Promise((t,i)=>{s=()=>{i(new l)},e.addEventListener("abort",s)}));try{await Promise.race([u.promise,i])}finally{null!=s&&null!=e&&(null==e||e.removeEventListener("abort",s))}}},null==h)return i;const y=i;return i={[Symbol.asyncIterator](){return this},next:()=>y.next(),throw:t=>(y.throw(t),null!=h&&(h(t),h=void 0),{done:!0}),return:()=>(y.return(),null!=h&&(h(),h=void 0),{done:!0}),push:p,end:t=>(y.end(t),null!=h&&(h(t),h=void 0),i),get readableLength(){return y.readableLength},onEmpty:t=>y.onEmpty(t)},i}(t=>{const e=t.shift();if(null==e)return{done:!0};if(null!=e.error)throw e.error;return{done:!0===e.done,value:e.value}},t)}class u extends Error{constructor(t,i,s){super(t??"The operation was aborted"),e(this,"type"),e(this,"code"),this.type="aborted",this.name=s??"AbortError",this.code=i??"ABORT_ERR"}}async function c(t,e,i){if(null==e)return t;if(e.aborted)return t.catch(()=>{}),Promise.reject(new u(null==i?void 0:i.errorMessage,null==i?void 0:i.errorCode,null==i?void 0:i.errorName));let s;const n=new u(null==i?void 0:i.errorMessage,null==i?void 0:i.errorCode,null==i?void 0:i.errorName);try{return await Promise.race([t,new Promise((t,i)=>{s=()=>{i(n)},e.addEventListener("abort",s)})])}finally{null!=s&&e.removeEventListener("abort",s)}}class f{constructor(){e(this,"readNext"),e(this,"haveNext"),e(this,"ended"),e(this,"nextResult"),e(this,"error"),this.ended=!1,this.readNext=r(),this.haveNext=r()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");const t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=r(),t}async throw(t){this.ended=!0,this.error=t,null!=t&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t));return{done:!0,value:void 0}}async return(){const t={done:!0,value:void 0};return this.ended=!0,this.nextResult=t,this.haveNext.resolve(),t}async push(t,e){await this._push(t,e)}async end(t,e){null!=t?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(null!=t&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=t?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=r(),await c(this.readNext.promise,null==e?void 0:e.signal,e)}}function d(){return new f}function p(t){return null!=t[Symbol.asyncIterator]}async function*b(t){const e=new AbortController,i=d();(async function(t,e,i){try{await Promise.all(t.map(async t=>{for await(const s of t)await e.push(s,{signal:i}),i.throwIfAborted()})),await e.end(void 0,{signal:i})}catch(s){await e.end(s,{signal:i}).catch(()=>{})}})(t,i,e.signal).catch(()=>{});try{yield*i}finally{e.abort()}}function w(...t){const e=[];for(const i of t)p(i)||e.push(i);return e.length===t.length?function*(t){for(const e of t)yield*e}(e):b(t)}function v(t){const[e,i]=null!=t[Symbol.asyncIterator]?[t[Symbol.asyncIterator](),Symbol.asyncIterator]:[t[Symbol.iterator](),Symbol.iterator],s=[];return{peek:()=>e.next(),push:t=>{s.push(t)},next:()=>s.length>0?{done:!1,value:s.shift()}:e.next(),[i](){return this}}}const y={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},S={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},g=new globalThis.TextEncoder;function m(t,{size:e=32,utf8Buffer:i}={}){if(!y[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof t){if(i)return function(t,e,i){if(0===i.length)throw new Error("The `utf8Buffer` option must have a length greater than zero");const s=y[e];let n=S[e],r=t;for(;r.length>0;){const t=g.encodeInto(r,i);r=r.slice(t.read);for(let r=0;r<t.written;r++)n^=BigInt(i[r]),n=BigInt.asUintN(e,n*s)}return n}(t,e,i);t=g.encode(t)}return function(t,e){const i=y[e];let s=S[e];for(let n=0;n<t.length;n++)s^=BigInt(t[n]),s=BigInt.asUintN(e,s*i);return s}(t,e)}const z={hash:t=>Number(m(t,{size:32})),hashV:(t,e)=>function(t){let e=t.toString(16);e.length%2==1&&(e=`0${e}`);return i(e,"base16")}(z.hash(t,e))};class x{constructor(t,i,n,r=2){if(e(this,"fp"),e(this,"h"),e(this,"seed"),r>64)throw new TypeError("Invalid Fingerprint Size");const h=i.hashV(t,n),o=s(r);for(let e=0;e<o.length;e++)o[e]=h[e];0===o.length&&(o[0]=7),this.fp=o,this.h=i,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return(null==t?void 0:t.fp)instanceof Uint8Array&&n(this.fp,t.fp)}}function k(t,e){return Math.floor(Math.random()*(e-t))+t}class E{constructor(t){e(this,"contents"),this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof x))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof x))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(null==this.contents[e])return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof x))throw new TypeError("Invalid Fingerprint");const e=k(0,this.contents.length-1),i=this.contents[e];return this.contents[e]=t,i}remove(t){if(!(t instanceof x))throw new TypeError("Invalid Fingerprint");const e=this.contents.findIndex(e=>t.equals(e));return e>-1&&(this.contents[e]=null,!0)}}class I{constructor(t){e(this,"bucketSize"),e(this,"filterSize"),e(this,"fingerprintSize"),e(this,"buckets"),e(this,"count"),e(this,"hash"),e(this,"seed"),this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??z,this.seed=t.seed??k(0,Math.pow(2,10))}add(t){"string"==typeof t&&(t=i(t));const e=new x(t,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(t,this.seed)%this.filterSize,n=(s^e.hash())%this.filterSize;if(null==this.buckets[s]&&(this.buckets[s]=new E(this.bucketSize)),null==this.buckets[n]&&(this.buckets[n]=new E(this.bucketSize)),this.buckets[s].add(e)||this.buckets[n].add(e))return this.count++,!0;const r=[s,n];let h=r[k(0,r.length-1)];null==this.buckets[h]&&(this.buckets[h]=new E(this.bucketSize));for(let i=0;i<500;i++){const t=this.buckets[h].swap(e);if(null!=t&&(h=(h^t.hash())%this.filterSize,null==this.buckets[h]&&(this.buckets[h]=new E(this.bucketSize)),this.buckets[h].add(t)))return this.count++,!0}return!1}has(t){var e,s;"string"==typeof t&&(t=i(t));const n=new x(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,h=(null==(e=this.buckets[r])?void 0:e.has(n))??!1;if(h)return h;const o=(r^n.hash())%this.filterSize;return(null==(s=this.buckets[o])?void 0:s.has(n))??!1}remove(t){var e,s;"string"==typeof t&&(t=i(t));const n=new x(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,h=(null==(e=this.buckets[r])?void 0:e.remove(n))??!1;if(h)return this.count--,h;const o=(r^n.hash())%this.filterSize,l=(null==(s=this.buckets[o])?void 0:s.remove(n))??!1;return l&&this.count--,l}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}}const N={1:.5,2:.84,4:.95,8:.98};function M(t,e=.001){const i=function(t=.001){return t>.002?2:t>1e-5?4:8}(e),s=N[i];return{filterSize:Math.round(t/s),bucketSize:i,fingerprintSize:Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*i)),64)}}class R{constructor(t){e(this,"filterSize"),e(this,"bucketSize"),e(this,"fingerprintSize"),e(this,"scale"),e(this,"filterSeries"),e(this,"hash"),e(this,"seed"),this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??z,this.seed=t.seed??k(0,Math.pow(2,10)),this.filterSeries=[new I({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if("string"==typeof t&&(t=i(t)),this.has(t))return!0;let e=this.filterSeries.find(t=>t.reliable);if(null==e){const t=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new I({filterSize:t,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){"string"==typeof t&&(t=i(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){"string"==typeof t&&(t=i(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}}function T(t,e=.001,i){return new R({...M(t,e)})}export{R as S,v as a,r as b,T as c,w as m,a as p,d as q,c as r};
