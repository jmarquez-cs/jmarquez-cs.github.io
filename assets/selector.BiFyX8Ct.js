var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{I as r,t as n,d as i,e as a}from"./index.BofkdKOa.js";import{l as o}from"./index.DnnBcP15.js";import{g as u,m as s,h as c,i as l,d,f as y,j as f,C as p,e as g,c as h,k as v}from"./message.Ve-2rN-7.js";import{g as m}from"./mermaid-core.CmyEpniE.js";import{d as T,e as b}from"./decode.9RDMYjMh.js";var w,V={exports:{}};w=V,function(){w.exports=g;var e=86400,t=3200,r=146097*t/400,n=e*r,i=1e3*n,a=864e13,o=4294967296,u=1e6,s="000000000",c=Math.trunc||function(e){var t=e-e%1;return 0==t&&(e<0||0===e&&1/e!=1/0)?-0:t},l=g.prototype,d=(g.fromDate=function(e){return new g(+e)},g.fromInt64BE=b(0,1,2,3,0,4),g.fromInt64LE=b(3,2,1,0,4,0),g.fromString=function(e){var t,r=new g;if(1<(e=(e+="").replace(/^\s*[+\-]?\d+/,function(e){var t=1970+((e=+e)-1970)%400;return r.year=e-t,t}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(e,r,n){return r<0&&(n*=-1),t=6e4*(60*+r+ +n),""}).replace(/\.\d+$/,function(e){return r.nano=+(e+s).substr(1,9),""}).split(/\D+/)).length?e[1]--:e[1]=0,r.time=t=Date.UTC.apply(Date,e)-(t||0),isNaN(t))throw new TypeError("Invalid Date");return h(r)},g.fromTimeT=function(e){return m(e,0)},l.year=0,l.time=0,l.nano=0,l.addNano=function(e){return this.nano+=+e||0,this},l.getNano=function(){var e=h(this);return(e.time%1e3*u+ +e.nano+1e9)%1e9},l.getTimeT=function(){var n=h(this),i=Math.floor(n.time/1e3);return(n=n.year)&&(i+=n*r*e/t),i},l.getYear=function(){return this.toDate().getUTCFullYear()+this.year},l.toDate=function(){return v(h(this).time)},l.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},l.toString=function(e){var t=this,r=t.toDate(),n={H:function(){return E(r.getUTCHours())},L:function(){return S(r.getUTCMilliseconds(),3)},M:function(){return E(r.getUTCMinutes())},N:function(){return S(t.getNano(),9)},S:function(){return E(r.getUTCSeconds())},Y:function(){var e=t.getYear();return 999999<e?"+"+e:9999<e?"+"+S(e,6):0<=e?S(e,4):-999999<=e?"-"+S(-e,6):e},a:function(){return f[r.getUTCDay()]},b:function(){return y[r.getUTCMonth()]},d:function(){return E(r.getUTCDate())},e:function(){return(9<(e=r.getUTCDate())?"":" ")+(0|e);var e},m:function(){return E(r.getUTCMonth()+1)}};return function e(t){return t.replace(/%./g,function(t){var r=t[1],i=p[r];return r=n[r],i?e(i):r?r():t})}(e||d)},l.writeInt64BE=T(0,1,2,3,0,4),l.writeInt64LE=T(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:"\n",R:"%H:%M",T:"%H:%M:%S",t:"\t",X:"%T",Z:"GMT",z:"+0000"};return g;function g(e,t,r){var n=this;if(!(n instanceof g))return new g(e,t,r);n.time=+e||0,n.nano=+t||0,n.year=+r||0,h(n)}function h(e){var r,n,o,s=e.year,l=e.time,d=e.nano,y=((d<0||u<=d)&&(d-=(n=Math.floor(d/u))*u,l+=n,n=1),s%t);return(l<-a||a<l||y)&&((r=c(l/i))&&(s+=r*t,l-=r*i),(o=v(l)).setUTCFullYear(y+o.getUTCFullYear()),o=(l=+o)+(r=c((s-=y)/t))*i,r&&-a<=o&&o<=a&&(s-=r*t,l=o),n=1),n&&(e.year=s,e.time=l,e.nano=d),e}function v(e){var t=new Date(0);return t.setTime(e),t}function m(e,r){e=+e||0;var i=c((r=(0|r)*o)/n)+c(e/n);return(e=c((r=r%n+e%n)/n))&&(i+=e,r-=e*n),new g(1e3*r,0,i*t)}function T(n,i,a,u,s,l){return function(n,i){var a=h(this);V(n=n||new Array(8),i|=0);var u=Math.floor(a.time/1e3),y=(a=a.year*(r*e/t),c(a/o)+c(u/o));return a=a%o+u%o,(u=Math.floor(a/o))&&(y+=u,a-=u*o),d(n,i+s,y),d(n,i+l,a),n};function d(e,t,r){e[t+n]=r>>24&255,e[t+i]=r>>16&255,e[t+a]=r>>8&255,e[t+u]=255&r}}function b(e,t,r,n,i,a){return function(e,t){V(e,t|=0);var r=o(e,t+i);return m(o(e,t+a),r)};function o(i,a){return 16777216*i[a+e]+(i[a+t]<<16|i[a+r]<<8|i[a+n])}}function V(e,t){if(null==(e=e&&e.length))throw new TypeError("Invalid Buffer");if(e<t+8)throw new RangeError("Out of range")}function E(e){return(9<e?"":"0")+(0|e)}function S(e,t){return(s+(0|e)).substr(-t)}}();const E=m(V.exports);class S extends Error{constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}}t(S,"name","SignatureCreationError");class k extends Error{constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}t(k,"name","SignatureVerificationError");class I extends Error{constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}t(I,"name","RecordExpiredError");class C extends Error{constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}t(C,"name","UnsupportedValidityError");class D extends Error{constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}t(D,"name","RecordTooLargeError");class R extends Error{constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}t(R,"name","InvalidValueError");class U extends Error{constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}t(U,"name","InvalidRecordDataError");class L extends Error{constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}var M;t(L,"name","InvalidEmbeddedPublicKeyError"),function(e){let t;var r;let n;(e.ValidityType||(e.ValidityType={})).EOL="EOL",(r=t||(t={}))[r.EOL=0]="EOL",function(e){e.codec=()=>u(t)}(e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==n&&(n=s((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.value&&(r.uint32(10),r.bytes(t.value)),null!=t.signatureV1&&(r.uint32(18),r.bytes(t.signatureV1)),null!=t.validityType&&(r.uint32(24),e.ValidityType.codec().encode(t.validityType,r)),null!=t.validity&&(r.uint32(34),r.bytes(t.validity)),null!=t.sequence&&(r.uint32(40),r.uint64(t.sequence)),null!=t.ttl&&(r.uint32(48),r.uint64(t.ttl)),null!=t.pubKey&&(r.uint32(58),r.bytes(t.pubKey)),null!=t.signatureV2&&(r.uint32(66),r.bytes(t.signatureV2)),null!=t.data&&(r.uint32(74),r.bytes(t.data)),!1!==n.lengthDelimited&&r.ldelim()},(t,r,n={})=>{const i={},a=null==r?t.len:t.pos+r;for(;t.pos<a;){const r=t.uint32();switch(r>>>3){case 1:i.value=t.bytes();break;case 2:i.signatureV1=t.bytes();break;case 3:i.validityType=e.ValidityType.codec().decode(t);break;case 4:i.validity=t.bytes();break;case 5:i.sequence=t.uint64();break;case 6:i.ttl=t.uint64();break;case 7:i.pubKey=t.bytes();break;case 8:i.signatureV2=t.bytes();break;case 9:i.data=t.bytes();break;default:t.skipType(7&r)}}return i})),n),e.encode=t=>c(t,e.codec()),e.decode=(t,r)=>l(t,e.codec(),r)}(M||(M={}));const x=o("ipns:utils"),q=y("/ipns/");function O(e){let t;if(null!=e.pubKey)try{t=i(e.pubKey)}catch(r){throw x.error(r),r}if(null!=t)return t}function K(e,t,r){const n=y(t);return f([e,r,n])}function $(e){const t=y("ipns-signature:");return f([t,e])}function N(e){return"signatureV1"in e?M.encode({value:y(e.value),signatureV1:e.signatureV1,validityType:e.validityType,validity:y(e.validity),sequence:e.sequence,ttl:e.ttl,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data}):M.encode({pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data})}function B(e){const t=M.decode(e);if(null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),null==t.signatureV2||null==t.data)throw new k("Missing data or signatureV2");const r=Y(t.data),i=function(e){const t=n(e).trim();if(t.startsWith("/"))return t;try{return`/ipfs/${p.decode(e).toV1().toString()}`}catch{}try{return`/ipfs/${p.parse(t).toV1().toString()}`}catch{}throw new R("Value must be a valid content path starting with /")}(r.Value),a=n(r.Validity);if(null!=t.value&&null!=t.signatureV1)return function(e){if(null==e.data)throw new U("Record data is missing");const t=Y(e.data);if(!g(t.Value,e.value??new Uint8Array(0)))throw new k('Field "value" did not match between protobuf and CBOR');if(!g(t.Validity,e.validity??new Uint8Array(0)))throw new k('Field "validity" did not match between protobuf and CBOR');if(t.ValidityType!==e.validityType)throw new k('Field "validityType" did not match between protobuf and CBOR');if(t.Sequence!==e.sequence)throw new k('Field "sequence" did not match between protobuf and CBOR');if(t.TTL!==e.ttl)throw new k('Field "ttl" did not match between protobuf and CBOR')}(t),{value:i,validityType:M.ValidityType.EOL,validity:a,sequence:r.Sequence,ttl:r.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(null!=t.signatureV2)return{value:i,validityType:M.ValidityType.EOL,validity:a,sequence:r.Sequence,ttl:r.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function F(e){return f([q,e.bytes])}function A(e){const t=d(e.slice(q.length));if(!Z(t,0)&&!Z(t,18))throw new r("Multihash in IPNS key was not identity or sha2-256");return t}function j(e,t,r,n,i){let a;if(t!==M.ValidityType.EOL)throw new C("The validity type is unsupported");a=0;return b({Value:e,Validity:r,ValidityType:a,Sequence:n,TTL:i})}function Y(e){const t=T(e);if(0!==t.ValidityType)throw new C("The validity type is unsupported");return t.ValidityType=M.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t}function z(e){if(null!=e){const t=function(e){if(function(e){return"function"==typeof(null==e?void 0:e.toCID)}(e))return e.toCID();try{return p.parse(e)}catch{}return p.asCID(e)}(e);if(null!=t)return 114===t.code?`/ipns/${t.toString(h)}`:`/ipfs/${t.toV1().toString()}`;if(e.bytes instanceof Uint8Array)return`/ipns/${h.encode(e.bytes)}`;const r=e.toString().trim();if(r.startsWith("/")&&r.length>1)return r}throw new R("Value must be a valid content path starting with /")}function Z(e,t){return e.code===t}const H=o("ipns:validator");async function P(e,t){if(t.byteLength>10240)throw new D("The record is too large");const r=A(e);let n;Z(r,0)&&(n=a(r));const i=O(B(t))??n;if(null==i)throw new L("Could not extract public key from IPNS record or routing key");const o=F(i.toMultihash());if(!g(o,e))throw new L("Embedded public key did not match routing key");await async function(e,t){const r=B(t);let n;try{const t=$(r.data);n=await e.verify(t,r.signatureV2)}catch(i){n=!1}if(!n)throw H.error("record signature verification failed"),new k("Record signature verification failed");if(r.validityType===M.ValidityType.EOL){if(E.fromString(r.validity).toDate().getTime()<Date.now())throw H.error("record has expired"),new I("record has expired")}else if(null!=r.validityType)throw H.error("the validity type is unsupported"),new C("The validity type is unsupported");H("ipns record for %s is valid",r.value)}(i,t)}var J;function W(e){const t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),i=String(e.getUTCHours()).padStart(2,"0"),a=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),u=e.getUTCMilliseconds();return`${t}-${r}-${n}T${i}:${a}:${o}.${String(1e3*u*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=s((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&e.key.byteLength>0&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),null!=e.timeReceived&&""!==e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==r.lengthDelimited&&t.ldelim()},(e,t,r={})=>{const n={key:v(0),value:v(0),timeReceived:""},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.bytes();break;case 2:n.value=e.bytes();break;case 5:n.timeReceived=e.string();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>c(t,e.codec()),e.decode=(t,r)=>l(t,e.codec(),r)}(J||(J={}));class G{constructor(e,r,n){if(t(this,"key"),t(this,"value"),t(this,"timeReceived"),!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(r instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=r,this.timeReceived=n}serialize(){return J.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:W(this.timeReceived)}}static deserialize(e){const t=J.decode(e);return new G(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=function(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),r=String(e).trim().match(t);if(null==r)throw new Error("Invalid format");const n=parseInt(r[1],10),i=parseInt(r[2],10)-1,a=parseInt(r[3],10),o=parseInt(r[4],10),u=parseInt(r[5],10),s=parseInt(r[6],10),c=parseInt(r[7].slice(0,-6),10);return new Date(Date.UTC(n,i,a,o,u,s,c))}(e.timeReceived);if(null==e.key)throw new Error("key missing from deserialized object");if(null==e.value)throw new Error("value missing from deserialized object");return new G(e.key,e.value,t)}}function X(e,t){const r=t.map((e,t)=>({record:B(e),index:t}));return r.sort((e,t)=>{const r=e.record.sequence,n=t.record.sequence;if(r>n)return-1;if(r<n)return 1;if(e.record.validityType===M.ValidityType.EOL&&t.record.validityType===M.ValidityType.EOL){const r=E.fromString(e.record.validity).toDate(),n=E.fromString(t.record.validity).toDate();if(r.getTime()>n.getTime())return-1;if(r.getTime()<n.getTime())return 1}return 0}),r[0].index}export{M as I,G as L,E as N,S,K as a,N as b,j as c,P as d,X as e,O as f,A as g,$ as i,F as m,z as n,B as u};
