var t=Object.defineProperty,e=(e,r,n)=>((e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);import{a as r,f as n}from"./message.Ve-2rN-7.js";import{P as s}from"./index.DnnBcP15.js";import{t as i}from"./index.BofkdKOa.js";import{g as a}from"./mermaid-core.CmyEpniE.js";function o(t){const e=[g.A];return null==t?e:Array.isArray(t)?0===t.length?e:t:[t]}function l(t){return{Status:t.Status??0,TC:t.TC??t.flag_tc??!1,RD:t.RD??t.flag_rd??!1,RA:t.RA??t.flag_ra??!1,AD:t.AD??t.flag_ad??!1,CD:t.CD??t.flag_cd??!1,Question:(t.Question??t.questions??[]).map(t=>({name:t.name,type:g[t.type]})),Answer:(t.Answer??t.answers??[]).map(t=>({name:t.name,type:g[t.type],TTL:t.TTL??t.ttl??60,data:t.data instanceof Uint8Array?i(t.data):t.data}))}}function u(t,e={}){const n=new s({concurrency:e.queryConcurrency??4});return async(e,s={})=>{var i;const a=new URLSearchParams;a.set("name",e),o(s.types).forEach(t=>{a.append("type",g[t])}),null==(i=s.onProgress)||i.call(s,new r("dns:query",{detail:e}));const u=await n.add(async()=>{var e;const n=await fetch(`${t}?${a}`,{headers:{accept:"application/dns-json"},signal:null==s?void 0:s.signal});if(200!==n.status)throw new Error(`Unexpected HTTP status: ${n.status} - ${n.statusText}`);const i=l(await n.json());return null==(e=s.onProgress)||e.call(s,new r("dns:response",{detail:i})),i},{signal:s.signal});if(null==u)throw new Error("No DNS response received");return u}}const c=a(function(t){if(!t)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,r=Object.create(null),n=Object.create(null);function s(s,i){r[s]=i,++e>=t&&(e=0,n=r,r=Object.create(null))}return{has:function(t){return void 0!==r[t]||void 0!==n[t]},remove:function(t){void 0!==r[t]&&(r[t]=void 0),void 0!==n[t]&&(n[t]=void 0)},get:function(t){var e=r[t];return void 0!==e?e:void 0!==(e=n[t])?(s(t,e),e):void 0},set:function(t,e){void 0!==r[t]?r[t]=e:s(t,e)},clear:function(){r=Object.create(null),n=Object.create(null)}}});class h{constructor(t){e(this,"lru"),this.lru=c(t)}get(t,e){let r=!0;const n=[];for(const s of e){const e=this.getAnswers(t,s);if(0===e.length){r=!1;break}n.push(...e)}if(r)return l({answers:n})}getAnswers(t,e){const r=`${t.toLowerCase()}-${e}`,n=this.lru.get(r);if(null!=n){const t=n.filter(t=>t.expires>Date.now()).map(({expires:t,value:e})=>({...e,TTL:Math.round((t-Date.now())/1e3),type:g[e.type]}));return 0===t.length&&this.lru.remove(r),t}return[]}add(t,e){const r=`${t.toLowerCase()}-${e.type}`,n=this.lru.get(r)??[];n.push({expires:Date.now()+1e3*(e.TTL??60),value:e}),this.lru.set(r,n)}remove(t,e){const r=`${t.toLowerCase()}-${e}`;this.lru.remove(r)}clear(){this.lru.clear()}}class f{constructor(t){var r;e(this,"resolvers"),e(this,"cache"),this.resolvers={},this.cache=(r=t.cacheSize??1e3,new h(r)),Object.entries(t.resolvers??{}).forEach(([t,e])=>{Array.isArray(e)||(e=[e]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=e}),null==this.resolvers["."]&&(this.resolvers["."]=[u("https://cloudflare-dns.com/dns-query"),u("https://dns.google/resolve")])}async query(t,e={}){var n,s,i;const a=o(e.types),l=!1!==e.cached?this.cache.get(t,a):void 0;if(null!=l)return null==(n=e.onProgress)||n.call(e,new r("dns:cache",{detail:l})),l;const u=`${t.split(".").pop()}.`,c=(this.resolvers[u]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),h=[];for(const o of c){if(!0===(null==(s=e.signal)?void 0:s.aborted))break;try{const r=await o(t,{...e,types:a});for(const e of r.Answer)this.cache.add(t,e);return r}catch(f){h.push(f),null==(i=e.onProgress)||i.call(e,new r("dns:error",{detail:f}))}}if(1===h.length)throw h[0];throw new AggregateError(h,`DNS lookup of ${t} ${a} failed`)}}var g,p;function d(t={}){return new f(t)}(p=g||(g={}))[p.A=1]="A",p[p.CNAME=5]="CNAME",p[p.TXT=16]="TXT",p[p.AAAA=28]="AAAA";const y="/",w=(new TextEncoder).encode(y),b=w[0];class m{constructor(t,r){if(e(this,"_buf"),"string"==typeof t)this._buf=n(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=t}if(null==r&&(r=!0),r&&this.clean(),0===this._buf.byteLength||this._buf[0]!==b)throw new Error("Invalid key")}toString(t="utf8"){return i(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new m(t.join(y))}static random(){return new m(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||"string"==typeof t?new m(t):"function"==typeof t.uint8Array?new m(t.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=w),this._buf[0]!==b){const t=new Uint8Array(this._buf.byteLength+1);t.fill(b,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===b;)this._buf=this._buf.subarray(0,-1)}less(t){const e=this.list(),r=t.list();for(let n=0;n<e.length;n++){if(r.length<n+1)return!1;const t=e[n],s=r[n];if(t<s)return!0;if(t>s)return!1}return e.length<r.length}reverse(){return m.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(y).slice(1)}type(){return function(t){const e=t.split(":");if(e.length<2)return"";return e.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(t){const e=t.split(":");return e[e.length-1]}(this.baseNamespace())}instance(t){return new m(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(y)||(t+=y),t+=this.type(),new m(t)}parent(){const t=this.list();return 1===t.length?new m(y):new m(t.slice(0,-1).join(y))}child(t){return this.toString()===y?t:t.toString()===y?this:new m(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()!==this.toString()&&t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()!==this.toString()&&this.toString().startsWith(t.toString())}isTopLevel(){return 1===this.list().length}concat(...t){return m.withNamespaces([...this.namespaces(),...(e=t.map(t=>t.namespaces()),[].concat(...e))]);var e}}export{m as K,g as R,d};
